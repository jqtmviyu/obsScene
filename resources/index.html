<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®æ—¶æ˜¾ç¤º OBS åœºæ™¯</title>
    <script src="./js/obs-websocket-js.js"></script>
    <script src="./js/neutralino.js"></script>
    <style>
      /* windows
      "width": 100,
      "height": 55,
      "minWidth": 100,
      "minHeight": 55,
      "useSavedState": true,
      */

      /* macos
      "width": 124,
      "height": 86,
      "minWidth": 124,
      "minHeight": 86,
      "useSavedState": false,
      */

      /*æ¸…é™¤å†…å¤–è¾¹è·,æ›´æ”¹ç›’å­æ¨¡å‹*/
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background-color: rgba(255, 255, 255, 0.5);
        padding-left: 4px;
        -webkit-user-select: none; /* Chrome, Safari, Opera */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
      }
      #drag-area {
        cursor: move;
      }
    </style>
  </head>
  <body>
    <div id="drag-area">
      <!-- <h2> OBS åœºæ™¯æ˜¾ç¤º </h2> -->
      <div id="click">çŠ¶æ€ï¼š<span id="status">æ­£åœ¨è¿æ¥...</span></div>
      <div>åœºæ™¯ï¼š<span id="currentScene">æœªçŸ¥</span></div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        Neutralino.init()
      })

      const obs = new OBSWebSocket()
      const reconnectInterval = 5000 // é‡è¿é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

      async function connectToOBS() {
        try {
          await obs.connect('ws://127.0.0.1:4444')
          console.log('å·²è¿æ¥åˆ° OBS WebSocket')
          document.getElementById('status').textContent = 'âœ…'

          obs.on('CurrentProgramSceneChanged', onCurrentSceneChanged)
          obs.once('ExitStarted', () => {
            console.log('OBS started shutdown')
            obs.off('CurrentSceneChanged', onCurrentSceneChanged)
          })

          // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶ä»¥è§¦å‘é‡è¿
          obs.on('ConnectionClosed', () => {
            document.getElementById('status').textContent = 'ğŸš«'
            console.log('è¿æ¥å…³é—­ï¼Œå‡†å¤‡é‡è¿...')
            setTimeout(connectToOBS, reconnectInterval)
          })
        } catch (error) {
          document.getElementById('status').textContent = 'ğŸ›'
          console.error('æ— æ³•è¿æ¥åˆ° OBS WebSocket:', error)
          setTimeout(connectToOBS, reconnectInterval)
        }
      }

      function onCurrentSceneChanged(event) {
        console.log('Current scene changed to', event.sceneName)

        if (event.sceneName.includes('éšç§')) {
          document.getElementById('currentScene').textContent = `â¤ï¸ ${event.sceneName}`
          document.body.style.color = 'red'
        } else {
          document.getElementById('currentScene').textContent = `ğŸ’š ${event.sceneName}`
          document.body.style.color = 'green'
        }
      }

      connectToOBS()

      /* ç§»åŠ¨äº‹ä»¶start */
      let isDragging = false
      let startX, startY
      let windowX, windowY
      let deltaX = 0
      let deltaY = 0
      let lastClickTime = 0
      const doubleClickThreshold = 200 // åŒå‡»æ—¶é—´é˜ˆå€¼ï¼Œå•ä½æ¯«ç§’

      const dragArea = document.getElementById('drag-area')

      dragArea.addEventListener('mousedown', e => {
        const currentTime = Date.now()
        if (currentTime - lastClickTime < doubleClickThreshold) {
          // æ£€æµ‹åˆ°åŒå‡»ï¼Œé€€å‡ºåº”ç”¨
          Neutralino.app.exit()
          return
        }

        lastClickTime = currentTime

        isDragging = true
        startX = e.clientX
        startY = e.clientY

        // è·å–å½“å‰çª—å£çš„ä½ç½®
        Neutralino.window.getPosition().then(position => {
          windowX = position.x
          windowY = position.y
        })

        document.addEventListener('mousemove', onMouseMove)
        document.addEventListener('mouseup', onMouseUp)
      })

      function onMouseMove(e) {
        if (isDragging) {
          deltaX = e.clientX - startX
          deltaY = e.clientY - startY
        }
      }

      function onMouseUp() {
        if (isDragging) {
          isDragging = false
          // ç§»åŠ¨çª—å£åˆ°æœ€ç»ˆä½ç½®
          Neutralino.window.move(windowX + deltaX, windowY + deltaY)
          document.removeEventListener('mousemove', onMouseMove)
          document.removeEventListener('mouseup', onMouseUp)
        }
      }

      /* ç§»åŠ¨äº‹ä»¶end */
    </script>
  </body>
</html>
